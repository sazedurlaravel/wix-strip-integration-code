//https://www.youtube.com/watch?v=lqO8wJx9wBY
//Page Code
import {createToken, encodeCard} from "public/stripeAPI.js";
import {subscription, createCustomer} from "backend/stripe";
import wixLocation from 'wix-location';

$w.onReady(function () {

});

var items = []; //your plan ID will go here (plan_XXXXXXXXXXXXXX)

var customer; 

function payNow() {
    var accepted = false;
    createToken(encodeCard(createCard())) //we start the process by encoding the card and creating a token
    .then((token) => {
    createCustomer(customer) //create a new customer
    .then((id) => {
        let item = {
            "customer": id, //this is your customer ID
            "items[0][plan]": items //this is your plan id
        };
        subscription(token, item) //subscribe
        .then((response) => {
            if (response.chargeId !== undefined) {
                accepted = true;
                wixLocation.to('/success'); //redirect on success
            } else {
                $w("#error").text = response.error; //show error message on failure
            }
            });
        });
    });
}

function createCard() {
    return {
        "address_city": $w("#city").value,
        "address_country": $w("#country").value,
        "address_state": $w("#state").value,
        "address_zip": $w("#zip").value,
        "address_line1": $w("#line1").value,
        "address_line2": $w("#line2").value,
        "name": $w("#name").value,
        "number": $w("#card").value,
        "cvc": $w("#cvv").value,
        "exp_year": $w("#yyyy").value,
        "exp_month": $w("#mm").value
    };
} 

export function pay_click(event) {
    payNow(); //start payment (you will need a button)
} 

export function email_change(event) {
    customer = $w("#email").value;
}

//Backend Code stripeAPI.js

import {fetch} from 'wix-fetch'; 

export async function createToken(card) {
  const apiKey = "PUBLIC_API_KEY";
  const response = await fetch("https://api.stripe.com/v1/tokens", {
  method: 'post',
  headers: {
  "Content-Type": "application/x-www-form-urlencoded",
  "Authorization": "Bearer " + apiKey
  },
  body: card
  });
  if (response.status >= 200 && response.status < 300) {
  const json = await response.json();
  return json.id;
  }
  const responseText = await response.text();
  return response.status;
}

export function encodeCard(card){
  let encoded = "";
  for (let [k, v] of Object.entries(card)) {
  encoded = encoded.concat("card[", k, "]=", encodeURI(v), "&");
}
  return encoded.substr(0, encoded.length - 1);
}

//Backend code stripe.jsw

import {fetch} from 'wix-fetch';

export async function subscription(token, item) {
  const cart = item;
  const apiKey = "SECRET_API_KEY";
  const response = await fetch("https://api.stripe.com/v1/subscriptions", {
  method: 'post',
  headers: {
    "Content-Type": "application/x-www-form-urlencoded",
    "Authorization": "Bearer " + apiKey
  },
  body: encodeBody(token, cart)
  });
  if (response.status >= 200 && response.status < 300) {
  // transaction successful - get charge ID
    const ret = await response.json();
    return {"chargeId": ret.id};
}
// transaction failed - return error messages and codes
  let res = await response.json();
  let err = res.error.message;
  let code = res.error.code;
  let type = res.error.type;
  return {"error": err, "code": code, "type": type};
}

function encodeBody(token, cart) {
  let encoded = "";
  for (let [k, v] of Object.entries(cart)) {
    encoded = encoded.concat(k,"=", encodeURI(v), "&");
  }
    encoded = encoded.concat("source=", encodeURI(token));
  return encoded;
}

//Creating a customer 

export async function createCustomer(customer) {
  const client = String(customer);
  const apiKey = "SECRET_API_KEY";
  const response = await fetch("https://api.stripe.com/v1/customers", {
  method: 'post',
  headers: {
    "Content-Type": "application/x-www-form-urlencoded",
    "Authorization": "Bearer " + apiKey
  },
  body: encodeClient(client)
  });
  if (response.status >= 200 && response.status < 300) {
  const json = await response.json();
  return json.id;
  }
  const responseText = await response.text();
  return response.status;
}

function encodeClient(client){
  let encoded = "";
  encoded = encoded.concat("email=", encodeURI(client));
  return encoded;
}
